
services:
  db:
    container_name: postgresql_db
    image: postgres:18.0-alpine
    restart: unless-stopped
    ports:
      - "5432:5432"
    expose:
      - "5432"
    environment:
      - POSTGRES_USER=$POSTGRES_USER
      - POSTGRES_PASSWORD=$POSTGRES_PASSWORD
      - POSTGRES_DB=$POSTGRES_DB
    volumes:
      - ./architecture/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
      - db_data:/var/lib/postgresql/18/main
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 10s 
      retries: 5
      start_period: 10s

  webapi:
    container_name: aspnet_web_api
    build:
      context: ./backend
      dockerfile: ./WebAPI/Dockerfile
    restart: unless-stopped
    env_file: ./backend/WebAPI/.env
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
        restart: true
      minio:
        condition: service_healthy
      backend-redis:
        condition: service_healthy
      mailhog:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  frontend:
    container_name: next_frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - SERVER_API_URL=${SERVER_API_URL}
      - FILE_SERVER_URL=${FILE_SERVER_URL}
    ports:
      - "3000:3000"
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    depends_on:
      nginx:
        condition: service_healthy
        restart: true

  moderation-app:
    container_name: moderation_app
    build:
      context: ./moderation-app
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=production
    depends_on:
      nginx:
        condition: service_healthy
        restart: true
     
  file-service:
    build:
      context: ./file-service
      dockerfile: ./Dockerfile
    ports:
      - "8005:8005"
    environment:
      - GIN_MODE=release
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY_ID=$MINIO_ROOT_USER
      - MINIO_SECRET_ACCESS_KEY=$MINIO_ROOT_PASSWORD
      - MINIO_USE_SSL=false
      - MINIO_PRESIGN_EXPIRY=15m
      - CACHE_TYPE=redis
      - REDIS_ENDPOINT=file-service-redis:6379
      - REDIS_PASSWORD=$REDIS_PASSWORD
      - REDIS_DB=0
      - SECURITY_API_KEY=${FILE_SERVICE_SECURITY_API_KEY}
    depends_on:
      minio:
        condition: service_healthy
        restart: true
      file-service-redis:
        condition: service_healthy
        restart: true
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8005/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  minio:
    container_name: minio_s3
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=$MINIO_ROOT_USER
      - MINIO_ROOT_PASSWORD=$MINIO_ROOT_PASSWORD
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
      
  nginx:
    container_name: nginx
    image: nginx:1.29.4-alpine
    ports:
      - "80:80"
    volumes:
      - ./architecture/nginx/nginx.conf:/etc/nginx/nginx.conf
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on:
      minio:
        condition: service_healthy
      file-service:
        condition: service_healthy
      webapi:
        condition: service_healthy

  backend-redis:
    container_name: backend_redis
    image: redis:8.4-alpine
    restart: unless-stopped
    command: >
      redis-server --requirepass ${REDIS_PASSWORD} --appendfsync everysec
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_USER=${REDIS_USER}
      - REDIS_USER_PASSWORD=${REDIS_USER}
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping"]
      interval: 10s
      timeout: 10s
      retries: 5
      
  file-service-redis:
    container_name: file_service_redis
    image: redis:8.4-alpine
    restart: unless-stopped
    command: >
      redis-server --requirepass ${REDIS_PASSWORD} --appendfsync everysec
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_USER=${REDIS_USER}
      - REDIS_USER_PASSWORD=${REDIS_USER}
    ports:
      - "6381:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping" ]
      interval: 10s
      timeout: 10s
      retries: 5
      
  mailhog:
    container_name: mailhog
    image: mailhog/mailhog
    restart: unless-stopped
    ports:
      - "1025"
      - "8025:8025"
    entrypoint: ["/bin/sh", "-c", "MailHog | awk '!/KEEPALIVE/'"]

  postgres-exporter:
    container_name: postgres_exporter
    image: prometheuscommunity/postgres-exporter:latest
    restart: unless-stopped
    environment:
      DATA_SOURCE_NAME: "host=db port=5432 user=${POSTGRES_USER} password=${POSTGRES_PASSWORD} database=${POSTGRES_DB:-postgres} sslmode=disable"
    ports:
      - "9187:9187"
    depends_on:
      db:
        condition: service_healthy

  backend-redis-exporter:
    container_name: backend_redis_exporter
    image: oliver006/redis_exporter:v1.80.1-alpine
    restart: unless-stopped
    environment:
      REDIS_ADDR: "redis://backend-redis:6379"
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
    ports:
      - "9121:9121"
    depends_on:
      backend-redis:
        condition: service_healthy
        
  file-service-redis-exporter:
    container_name: file_service_redis_exporter
    image: oliver006/redis_exporter:v1.80.1-alpine
    restart: unless-stopped
    environment:
      REDIS_ADDR: "redis://file-service-redis:6379"
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
    ports:
      - "9122:9121"
    depends_on:
      file-service-redis:
        condition: service_healthy

  prometheus:
    container_name: prometheus
    image: prom/prometheus:v3.8.0
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./architecture/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9090/-/healthy || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      - postgres-exporter
      - backend-redis-exporter
      - file-service-redis-exporter

  grafana:
    container_name: grafana
    image: grafana/grafana:12.4.0-20151846001
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=
    volumes:
      - grafana_data:/var/lib/grafana
      - ./architecture/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      prometheus:
        condition: service_healthy

volumes:
  db_data:
  minio_data:
  redis_data:
  prometheus_data:
  grafana_data:
